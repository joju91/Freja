<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini GeoGuessr</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Precisions-cursor för gissningskartor */
    #guessMap { cursor: crosshair; }
    /* Global */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Montserrat', sans-serif; }
    /* Startskärm */
    .start-screen { position: fixed; inset: 0; background: linear-gradient(135deg,#667eea,#764ba2); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .start-content { background: rgba(0,0,0,0.5); padding: 2rem; border-radius: 8px; max-width: 400px; text-align: center; color: #fff; }
    .start-content h1 { font-size: 2rem; margin-bottom: 1rem; }
    .start-content p { margin-bottom: 1.5rem; }
    .start-content select, .start-content input[type=number] { width: 100%; margin-bottom: 1rem; padding: 0.5rem; border-radius: 4px; border: none; font-size: 1rem; }
    .start-button { background: linear-gradient(45deg,#ff6b6b,#ff8e53); border: none; padding: 0.75rem 1rem; color: #fff; border-radius: 25px; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; }
    /* Spel */
    #gameContainer { display: none; position: relative; width: 100%; height: 100%; }
    .score-bar { position: absolute; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); display: flex; justify-content: space-around; padding: 0.5rem; z-index: 500; }
    .timer { font-weight: bold; }
    .game-layout { display: flex; height: 100%; }
    .map-container { flex: 1; position: relative; }
    #streetMap, #guessMap { width: 100%; height: 100%; }
    .message-box { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); background: #fff; padding: 0.5rem 1rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 600; display: none; }
    /* Animation feedback */
    .bounce { animation: bounce 0.5s; }
    @keyframes bounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
  </style>
</head>
<body>
  <div id="startScreen" class="start-screen">
    <div class="start-content">
      <h1>Mini GeoGuessr</h1>
      <p>Utforska världen!</p>
      <select id="regionSelect">
        <option value="all">Alla regioner</option>
        <option value="europe">Europa</option>
        <option value="asia">Asien</option>
        <option value="america">Amerika</option>
      </select>
      <select id="modeSelect">
        <option value="map">Karta</option>
        <option value="text">Text</option>
      </select>
      <input id="roundsInput" type="number" min="1" max="20" value="5" placeholder="Antal rundor" />
      <button id="startButton" class="start-button">Starta äventyret</button>
    </div>
  </div>
  <div id="gameContainer">
    <div class="score-bar">
      <div id="roundInfo">Runda: 0/0</div>
      <div id="scoreInfo">Poäng: 0</div>
      <div class="timer" id="timer">Tid: 0s</div>
    </div>
    <div class="game-layout">
      <div id="streetContainer" class="map-container">
        <div id="streetMap"></div>
      </div>
      <div class="map-container"><div id="guessMap"></div></div>
    </div>
    <div id="messageBox" class="message-box"></div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Init och variabler
    const CITIES = [
      {name:"Stockholm, Sverige",lat:59.3293,lon:18.0686,region:"europe"},
      {name:"Oslo, Norge",lat:59.9139,lon:10.7522,region:"europe"},
      {name:"Malmö, Sverige",lat:55.6050,lon:13.0038,region:"europe"},
      {name:"Visby, Sverige",lat:57.6348,lon:18.2948,region:"europe"},
      {name:"Berlin, Tyskland",lat:52.52,lon:13.4050,region:"europe"},
      {name:"Paris, Frankrike",lat:48.8566,lon:2.3522,region:"europe"},
      {name:"Aten, Grekland",lat:37.9838,lon:23.7275,region:"europe"},
      {name:"Tokyo, Japan",lat:35.6762,lon:139.6503,region:"asia"},
      {name:"Bangkok, Thailand",lat:13.7563,lon:100.5018,region:"asia"},
      {name:"Singapore",lat:1.3521,lon:103.8198,region:"asia"},
      {name:"New York, USA",lat:40.7128,lon:-74.0060,region:"america"},
      {name:"Los Angeles, USA",lat:34.0522,lon:-118.2437,region:"america"},
      {name:"Vancouver, Kanada",lat:49.2827,lon:-123.1207,region:"america"},
      {name:"Miami, USA",lat:25.7617,lon:-80.1918,region:"america"}
    ];
    let TOTAL_ROUNDS, currentRound = 0, score = 0, timerInterval, timeLeft, mode;
    let streetMap, guessMap, guessMarker, actualMarker, lineMarker, currentLocation;
    const startScreen = document.getElementById('startScreen');
    const gameContainer = document.getElementById('gameContainer');
    const startButton = document.getElementById('startButton');
    const regionSelect = document.getElementById('regionSelect');
    const modeSelect = document.getElementById('modeSelect');
    const roundsInput = document.getElementById('roundsInput');
    const roundInfo = document.getElementById('roundInfo');
    const scoreInfo = document.getElementById('scoreInfo');
    const timerEl = document.getElementById('timer');
    const messageBox = document.getElementById('messageBox');

    document.addEventListener('DOMContentLoaded', () => {
      startButton.addEventListener('click', startGame);
    });

    function startGame() {
      TOTAL_ROUNDS = parseInt(roundsInput.value) || 5;
      mode = modeSelect.value;
      startScreen.style.display = 'none';
      gameContainer.style.display = 'block';
      initMaps();
      nextRound();
    }

    function initMaps() {
      const opts = { scrollWheelZoom: false, doubleClickZoom: false, minZoom: 2, maxZoom: 12 };
      streetMap = L.map('streetMap', opts).setView([59.3293, 18.0686], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.se/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(streetMap);

      const guessOpts = { zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, minZoom: 2, maxZoom: 12 };
      guessMap = L.map('guessMap', guessOpts).setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.se/{z}/{x}/{y}.png').addTo(guessMap);

      guessMap.on('click', e => {
        if (!guessMarker) makeGuess(e.latlng);
      });
    }

    function nextRound() {
      if (currentRound >= TOTAL_ROUNDS) { endGame(); return; }
      currentRound++;
      clearMarkers();
      updateUI();
      const pool = CITIES.filter(c => regionSelect.value === 'all' || c.region === regionSelect.value);
      currentLocation = pool[Math.floor(Math.random() * pool.length)];
      streetMap.setView([currentLocation.lat, currentLocation.lon], 8);
      startTimer(30);
    }

    function startTimer(sec) {
      clearInterval(timerInterval);
      timeLeft = sec;
      timerEl.textContent = `Tid: ${timeLeft}s`;
      timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `Tid: ${timeLeft}s`;
        if (timeLeft <= 0) { clearInterval(timerInterval); makeGuess(null); }
      }, 1000);
    }

    function makeGuess(latlng) {
      clearInterval(timerInterval);
      const lat = latlng ? latlng.lat : currentLocation.lat;
      const lon = latlng ? latlng.lng : currentLocation.lon;
      guessMarker = L.marker([lat, lon]).addTo(guessMap).getElement().classList.add('bounce');
      actualMarker = L.marker([currentLocation.lat, currentLocation.lon]).addTo(guessMap).getElement().classList.add('bounce');
      lineMarker = L.polyline([[lat, lon], [currentLocation.lat, currentLocation.lon]], { color: 'red' }).addTo(guessMap);
      const dist = calcDist(lat, lon, currentLocation.lat, currentLocation.lon);
      const bonus = dist < 50 ? 200 : 0;
      const pts = Math.max(0, 1000 - Math.round(dist)) + bonus;
      score += pts;
      updateUI();
      showMessage(`${Math.round(dist)} km - ${pts} p${bonus ? ' (+bonus)' : ''}`, true, () => {
        clearMessage();
        nextRound();
      });
    }

    function calcDist(a, b, c, d) {
      const R = 6371;
      const dLat = (c - a) * Math.PI / 180;
      const dLon = (d - b) * Math.PI / 180;
      const a2 = Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
      const c2 = 2 * Math.atan2(Math.sqrt(a2), Math.sqrt(1-a2));
      return R * c2;
    }

    function clearMarkers() {
      if (guessMarker) guessMarker.remove();
      if (actualMarker) actualMarker.remove();
      if (lineMarker) lineMarker.remove();
      guessMarker = actualMarker = lineMarker = null;
    }

    function updateUI() {
      document.getElementById('roundInfo').textContent = `Runda: ${currentRound}/${TOTAL_ROUNDS}`;
      document.getElementById('scoreInfo').textContent = `Poäng: ${score}`;
    }

    function showMessage(text, clickable = false, cb = null) {
      messageBox.textContent = text;
      messageBox.style.display = 'block';
      if (clickable) {
        messageBox.onclick = () => { messageBox.style.display = 'none'; messageBox.onclick = null; cb(); };
      } else {
        setTimeout(clearMessage, 2000);
      }
    }

    function clearMessage() {
      messageBox.style.display = 'none';
      messageBox.onclick = null;
    }

    function endGame() {
      showMessage(`Spelet slut! Totalpoäng: ${score}`, true, () => location.reload());
    }
  </script>
</body>
</html>
